# yarn 1 升级到 yarn 2.x/3.x

## 从 v1 升级到 v2

[参考迁移指南](https://yarnpkg.com/getting-started/migration#step-by-step)

> Note: Don't worry if your project isn't quite ready for Plug'n'Play just yet! This guide will let you migrate without losing your node_modules folder. Only in a later optional section we will cover how to enable PnP support, and this part will only be recommended, not mandatory. Baby steps! 😉

> Note that those commands only need to be run once for the whole project and will automatically take effect for all your contributors as soon as they pull the migration commit, thanks to the power of yarnPath:

1. Run npm install -g yarn to update the global yarn version to latest v1
2. Go into your project directory
3. Run yarn set version berry to enable v2 (cf Install for more details)
4. If you used .npmrc or .yarnrc, you'll need to turn them into the new format (see also 1, 2)
5. Add nodeLinker: node-modules in your .yarnrc.yml file
6. Commit the changes so far (yarn-X.Y.Z.js, .yarnrc.yml, ...)
7. Run yarn install to migrate the lockfile
8. Take a look at this article to see what should be gitignored
9. Commit everything remaining

Some optional features are available via external plugins:

10. Run yarn plugin import interactive-tools if you want upgrade-interactive
11. Run yarn plugin list to see what other official plugins exist and might be useful
12. Commit the yarn plugins

Good, you should now have a working Yarn install! Some things might still require a bit of work (for instance we deprecated arbitrary pre/post-scripts, and renamed --frozen-lockfile into --immutable), but those special cases will be documented on a case-by-case basis in the rest of this document (for example here).

## 升级中遇到的错误

### info There appears to be trouble with your network connection. Retrying...

```bash
$ yarn set version berry
warning package.json: No license field
info There appears to be trouble with your network connection. Retrying...
info There appears to be trouble with your network connection. Retrying...
error An unexpected error occurred: "https://github.com/yarnpkg/berry/raw/master/packages/yarnpkg-cli/bin/yarn.js: connect ECONNREFUSED 0.0.0.0:443".
info If you think this is a bug, please open a bug report with the information provided in "/Users/mark/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/policies for documentation about this command.

```

这是因为网络的原因导致。如果你使用了诸如`shadowsocks`的代理。你需要设置下 proxy。

```bash
# xxx是shadowsocks代理的端口号
$ yarn config set proxy http://127.0.0.1:xxx
$ yarn config set https-proxy http://127.0.0.1:xxx
```

## error Command "set" not found.

执行`yarn set version`报如题的错误。

这是因为`yarn set version`v1 不支持，需要用`yarn policies set-version`

[[Feature] A command to set yarn version that works on both v1 and v2](https://github.com/yarnpkg/berry/issues/773)

## error An unexpected error occurred

在 v1 版本下执行`yarn policies set-version berry`，报错：

```bash
$ yarn policies set-version berry

Resolving berry to a url...
Downloading https://github.com/yarnpkg/berry/raw/master/packages/berry-cli/bin/berry.js...
error An unexpected error occurred: "https://github.com/yarnpkg/berry/raw/master/packages/berry-cli/bin/berry.js: connect ECONNREFUSED 0.0.0.0:443".
info If you think this is a bug, please open a bug report with the information provided in "/Users/mark/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/policies for documentation about this command.
```

同样是网络不好导致的。参考「升级中遇到的错误」的第一条

## Error: Cannot find module....

```bash
internal/modules/cjs/loader.js:892
  throw err;
  ^

Error: Cannot find module '/Users/mark/.yarn/releases/yarn-1.22.17.cjs'
```

这是因为`~/.yarnrc`中的`yarn-path`，或者`.yarnrc.yml`中的`yarnPath`指向的问题。

### 查看`~/.yarnrc`，`vi ~/.yarnrc`：

```bash
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1


https-proxy "http://127.0.0.1:xxx"
lastUpdateCheck xxx
proxy "http://127.0.0.1:xxx"
yarn-path "/Users/mark/.yarn/releases/yarn-1.22.17.cjs"
```

### `cd ~/.yarn/releases/` 查看有哪些 yarn 的版本

```bash
$ ls

yarn-3.1.1.cjs
```

将`~/.yarnrc`中的`yarn-path`设成`yarn-3.1.1.cjs`，错误解决。

但是这种方式，当你切换 yarn 的版本的时候，如`yarn set version 1.22.17`之后，又回报`yarn-3.1.1.cjs`找不到。

### 删除`~/.yarnrc`或者`.yarnrc.yml`

[相关 issue](https://github.com/yarnpkg/yarn/issues/8460)

## 项目下自己的 yarn releases 版本被全局的 yarn 覆盖

在项目下执行`yarn -v`，输出`3.0.0`。即使`.yarnrc.yml`中的设置为：`yarnPath: .yarn/releases/yarn-3.1.1.cjs`

这时因为全局的`.yarnrc.yml`或者`.yarnrc`中设了`yarnPath`。将其注释调，即可解决。
