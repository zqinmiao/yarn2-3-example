# yarn 1 å‡çº§åˆ° yarn 2.x/3.x

## ä» v1 å‡çº§åˆ° v2

[å‚è€ƒè¿ç§»æŒ‡å—](https://yarnpkg.com/getting-started/migration#step-by-step)

> Note: Don't worry if your project isn't quite ready for Plug'n'Play just yet! This guide will let you migrate without losing your node_modules folder. Only in a later optional section we will cover how to enable PnP support, and this part will only be recommended, not mandatory. Baby steps! ğŸ˜‰

> Note that those commands only need to be run once for the whole project and will automatically take effect for all your contributors as soon as they pull the migration commit, thanks to the power of yarnPath:

1. Run npm install -g yarn to update the global yarn version to latest v1
2. Go into your project directory
3. Run yarn set version berry to enable v2 (cf Install for more details)
4. If you used .npmrc or .yarnrc, you'll need to turn them into the new format (see also 1, 2)
5. Add nodeLinker: node-modules in your .yarnrc.yml file
6. Commit the changes so far (yarn-X.Y.Z.js, .yarnrc.yml, ...)
7. Run yarn install to migrate the lockfile
8. Take a look at this article to see what should be gitignored
9. Commit everything remaining

Some optional features are available via external plugins:

10. Run yarn plugin import interactive-tools if you want upgrade-interactive
11. Run yarn plugin list to see what other official plugins exist and might be useful
12. Commit the yarn plugins

Good, you should now have a working Yarn install! Some things might still require a bit of work (for instance we deprecated arbitrary pre/post-scripts, and renamed --frozen-lockfile into --immutable), but those special cases will be documented on a case-by-case basis in the rest of this document (for example here).

## å‡çº§ä¸­é‡åˆ°çš„é”™è¯¯

### info There appears to be trouble with your network connection. Retrying...

```bash
$ yarn set version berry
warning package.json: No license field
info There appears to be trouble with your network connection. Retrying...
info There appears to be trouble with your network connection. Retrying...
error An unexpected error occurred: "https://github.com/yarnpkg/berry/raw/master/packages/yarnpkg-cli/bin/yarn.js: connect ECONNREFUSED 0.0.0.0:443".
info If you think this is a bug, please open a bug report with the information provided in "/Users/mark/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/policies for documentation about this command.

```

è¿™æ˜¯å› ä¸ºç½‘ç»œçš„åŸå› å¯¼è‡´ã€‚å¦‚æœä½ ä½¿ç”¨äº†è¯¸å¦‚`shadowsocks`çš„ä»£ç†ã€‚ä½ éœ€è¦è®¾ç½®ä¸‹ proxyã€‚

```bash
# xxxæ˜¯shadowsocksä»£ç†çš„ç«¯å£å·
$ yarn config set proxy http://127.0.0.1:xxx
$ yarn config set https-proxy http://127.0.0.1:xxx
```

## error Command "set" not found.

æ‰§è¡Œ`yarn set version`æŠ¥å¦‚é¢˜çš„é”™è¯¯ã€‚

è¿™æ˜¯å› ä¸º`yarn set version`v1 ä¸æ”¯æŒï¼Œéœ€è¦ç”¨`yarn policies set-version`

[[Feature] A command to set yarn version that works on both v1 and v2](https://github.com/yarnpkg/berry/issues/773)

## error An unexpected error occurred

åœ¨ v1 ç‰ˆæœ¬ä¸‹æ‰§è¡Œ`yarn policies set-version berry`ï¼ŒæŠ¥é”™ï¼š

```bash
$ yarn policies set-version berry

Resolving berry to a url...
Downloading https://github.com/yarnpkg/berry/raw/master/packages/berry-cli/bin/berry.js...
error An unexpected error occurred: "https://github.com/yarnpkg/berry/raw/master/packages/berry-cli/bin/berry.js: connect ECONNREFUSED 0.0.0.0:443".
info If you think this is a bug, please open a bug report with the information provided in "/Users/mark/yarn-error.log".
info Visit https://yarnpkg.com/en/docs/cli/policies for documentation about this command.
```

åŒæ ·æ˜¯ç½‘ç»œä¸å¥½å¯¼è‡´çš„ã€‚å‚è€ƒã€Œå‡çº§ä¸­é‡åˆ°çš„é”™è¯¯ã€çš„ç¬¬ä¸€æ¡

## Error: Cannot find module....

```bash
internal/modules/cjs/loader.js:892
  throw err;
  ^

Error: Cannot find module '/Users/mark/.yarn/releases/yarn-1.22.17.cjs'
```

è¿™æ˜¯å› ä¸º`~/.yarnrc`ä¸­çš„`yarn-path`ï¼Œæˆ–è€…`.yarnrc.yml`ä¸­çš„`yarnPath`æŒ‡å‘çš„é—®é¢˜ã€‚

### æŸ¥çœ‹`~/.yarnrc`ï¼Œ`vi ~/.yarnrc`ï¼š

```bash
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1


https-proxy "http://127.0.0.1:xxx"
lastUpdateCheck xxx
proxy "http://127.0.0.1:xxx"
yarn-path "/Users/mark/.yarn/releases/yarn-1.22.17.cjs"
```

### `cd ~/.yarn/releases/` æŸ¥çœ‹æœ‰å“ªäº› yarn çš„ç‰ˆæœ¬

```bash
$ ls

yarn-3.1.1.cjs
```

å°†`~/.yarnrc`ä¸­çš„`yarn-path`è®¾æˆ`yarn-3.1.1.cjs`ï¼Œé”™è¯¯è§£å†³ã€‚

ä½†æ˜¯è¿™ç§æ–¹å¼ï¼Œå½“ä½ åˆ‡æ¢ yarn çš„ç‰ˆæœ¬çš„æ—¶å€™ï¼Œå¦‚`yarn set version 1.22.17`ä¹‹åï¼Œåˆå›æŠ¥`yarn-3.1.1.cjs`æ‰¾ä¸åˆ°ã€‚

### åˆ é™¤`~/.yarnrc`æˆ–è€…`.yarnrc.yml`

[ç›¸å…³ issue](https://github.com/yarnpkg/yarn/issues/8460)

## é¡¹ç›®ä¸‹è‡ªå·±çš„ yarn releases ç‰ˆæœ¬è¢«å…¨å±€çš„ yarn è¦†ç›–

åœ¨é¡¹ç›®ä¸‹æ‰§è¡Œ`yarn -v`ï¼Œè¾“å‡º`3.0.0`ã€‚å³ä½¿`.yarnrc.yml`ä¸­çš„è®¾ç½®ä¸ºï¼š`yarnPath: .yarn/releases/yarn-3.1.1.cjs`

è¿™æ—¶å› ä¸ºå…¨å±€çš„`.yarnrc.yml`æˆ–è€…`.yarnrc`ä¸­è®¾äº†`yarnPath`ã€‚å°†å…¶æ³¨é‡Šè°ƒï¼Œå³å¯è§£å†³ã€‚
